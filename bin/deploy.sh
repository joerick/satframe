#!/bin/bash

# ==========================================
# Satframe Idempotent Setup Script
# ==========================================

# Configuration
TARGET_USER="joerick"
HOME_DIR="/home/$TARGET_USER"
SATFRAME_REPO="https://github.com/joerick/satframe.git"
INKY_REPO="https://github.com/pimoroni/inky.git"

# Ensure the script is run as root
if [ "$EUID" -ne 0 ]; then 
  echo "Please run as root (sudo)"
  exit 1
fi

echo "--- Starting Satframe Setup ---"

# ------------------------------------------
# 1. Install System Dependencies (APT)
# ------------------------------------------
echo "Installing system dependencies via apt..."
# Combined list from your snippet + node requirements
apt-get update
apt-get install -y \
    git \
    libwebpmux3 \
    libwebpdemux2 \
    liblcms2-2 \
    libopenjp2-7 \
    libopenblas0-pthread \
    libgfortran5 \
    npm \
    chromium \
    chromium-headless-shell \
    python3-venv \
    python3-pip

# ------------------------------------------
# 2. Tailscale Check & Install
# ------------------------------------------
if command -v tailscale &> /dev/null; then
    echo "✅ Tailscale is already installed."
else
    echo " "
    echo "⚠️  Tailscale is NOT installed."
    echo "----------------------------------------------------------------"
    echo "Paste the installation command from the Tailscale Admin Console."
    echo "Example: curl -fsSL https://tailscale.com/install.sh | sh"
    echo " "
    echo "(Leave blank and press ENTER to skip)"
    echo "----------------------------------------------------------------"
    
    read -r -p "Command > " TS_CMD

    if [ -n "$TS_CMD" ]; then
        echo "Executing Tailscale setup..."
        # We use eval to handle pipes (|) and complex commands passed in the string
        eval "$TS_CMD"
    else
        echo "Skipping Tailscale installation."
    fi
fi

# ------------------------------------------
# 2. Repositories (Clone or Update)
# ------------------------------------------
ensure_repo() {
    local repo_url=$1
    local target_dir=$2
    
    if [ -d "$target_dir/.git" ]; then
        echo "Updating $(basename $target_dir)..."
        sudo -u $TARGET_USER git -C "$target_dir" pull
    else
        echo "Cloning $(basename $target_dir)..."
        sudo -u $TARGET_USER git clone "$repo_url" "$target_dir"
    fi
}

echo "Checking repositories..."
ensure_repo "$SATFRAME_REPO" "$HOME_DIR/satframe"
ensure_repo "$INKY_REPO" "$HOME_DIR/inky"

# ------------------------------------------
# 3. Application Setup (Running as User)
# ------------------------------------------
echo "Running Application Setup (Pip/Npm) as $TARGET_USER..."

# We use a heredoc (<< 'EOF') to switch context to the user 'joerick'.
# This ensures env and node_modules are owned by joerick, not root.
sudo -u $TARGET_USER bash << 'EOF'

# Fail on error
set -e

cd ~/satframe

# --- Python Setup ---
if [ ! -d "env" ]; then
    echo "Creating virtual environment..."
    python3 -m venv env
fi

source env/bin/activate

echo "Installing Python dependencies..."
# Pin versions as requested
pip install \
    -i https://www.piwheels.org/simple/ \
    pillow==10.4.0 \
    numpy==2.2.0

# Install Inky (from sibling directory)
if [ -d "../inky" ]; then
    echo "Installing Inky library..."
    # We execute this in a subshell so we don't lose our current directory
    (
        export PIP_EXTRA_INDEX_URL=https://www.piwheels.org/simple/
        cd ../inky 
        ./install.sh
    )
else
    echo "Warning: Inky directory not found, skipping install."
fi

# --- Node Setup ---
echo "Installing Node dependencies..."
# Ensure we are in satframe root
cd ~/satframe 
npm install

EOF

# ------------------------------------------
# 4. Cron Configuration
# ------------------------------------------
echo "Configuring Cron..."

cat <<OUTPUT > /etc/cron.d/satframe
# /etc/cron.d/satframe - Generated by setup script

# Reboot the system daily at 3 AM
0  3    * * * root    /sbin/reboot

# Run satframe as user $TARGET_USER every 30 minutes
*/30 * * * * $TARGET_USER $HOME_DIR/satframe/run.sh 2>&1 | logger -t satframe

# refresh the screen on boot as well
@reboot         $TARGET_USER $HOME_DIR/satframe/run.sh | logger -t satframe
OUTPUT

chmod 644 /etc/cron.d/satframe
echo "Cron configuration updated."

# ------------------------------------------
# 5. Tailscale & Journald Config
# ------------------------------------------
if command -v tailscale &> /dev/null; then
    echo "Configuring Tailscale logging..."
    mkdir -p "/etc/systemd/system/tailscaled.service.d"
    cat <<TSCONF > "/etc/systemd/system/tailscaled.service.d/override.conf"
[Service]
LogLevelMax=notice
TSCONF
    systemctl daemon-reload
fi

echo "Configuring Journald..."
CONF_FILE="/etc/systemd/journald.conf"
if ! grep -q "^SystemMaxUse=500M" "$CONF_FILE"; then
    if grep -q "SystemMaxUse" "$CONF_FILE"; then
        sed -i 's/^#\?SystemMaxUse=.*/SystemMaxUse=500M/' "$CONF_FILE"
    else
        echo "SystemMaxUse=500M" >> "$CONF_FILE"
    fi
    systemctl restart systemd-journald
fi

echo "--- Setup Complete! ---"
echo "Rebooting in 5 seconds..."
sleep 5
reboot